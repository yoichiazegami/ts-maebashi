M+ Stroke — テキスト内容適応型タイポグラフィエンジン
====================================================

＊注意
- 自然言語処理の技術については勉強しながらの作成なので、技術的な語用がおそらく全然正確ではない



作れるといいもの
1. テキスト自身がプロンプトとなり、自らの表示スタイルを選択する（ように見える）システム
- 鑑賞者が実際にテキストを入力できるので、見せかけのコンセプトモデルではダメ
2. 既存のフォント（＝タイポグラフィ枠組み／離散的な選択肢）に依存せず、多様な文字スタイルを連続的に表現できる方法のプロトタイプ


作ってみたもの
1. 入力されたテキストの意味・感情・文体・モチーフを分析し、テキスト自身に最適なスタイルを推測するシステム
- ユーザーからは、テキスト自身がプロンプトとなり、自らの表示スタイルを選択しているように見える
- 実際の内部には、目的や分析内容を記述した長いプロンプトがある。ユーザーによって入力されたテキストはプロンプトのごく一部なので、エンジニア側の感覚的には「テキスト自身がプロンプト」とは言いにくい

2. ストロークフォントのパスに対して機械的な処理を行い、多様な文字スタイルを表現できるツール
- 「M+ 1p」フォントのストロークパスデータ（オープンソース）を利用している。ストロークの太さや形状の変更、パスの変形処理、字間調整などを行えるようになっており、それぞれの程度をパラメーターとして持っている。現在は9次元
- バリアブルフォントと異なるのは、人間が描いた輪郭の間を補完するのではなく、機械的な一律処理によって骨格や肉付きを変形させている点
- 複数の処理が特定の噛み合い方をした結果として、「手書き風」「ゴシック風」「明朝風」「ファンテール風」「ゲバ文字風」など、特定のスタイルとして認識可能な形状が得られる
- ある程度広い範囲のスタイルを連続的に表現できる性質を重視する必要があるので、美しさや可読性は度外視


- 一般的な「画像生成AI」的なビットマップ方式も考えたが、コストが高そうなのと、ハードルがかなり高そうなのでやめた
- 
- 文字をある程度高精度に生成可能な現在の汎用モデルはおそらく、いくつかのオープンソースフォントを丸ごと特別に学習させているだけ。たとえばChatGPTでは、和文はNotoっぽい文字ばっかり出る。幅広い文字スタイルを表現できる性質よりも、読める文字を生成結果に組み込める性質が重視されている




スタイルの最適化方式
1. k-NN方式の学習（土台）
- 多様なテキストを用意し、それ対して最適と思われるスタイルを手動で選択することで、テキストとスタイルのペアのサンプルを作成した（現在214件）
- それによって、テキストの意味空間と、文字のスタイル空間の対応関係を学習させた
- 未知のテキストが入力された際、その対応関係をもとに計算して最適なスタイルを導き出すことができる
- 分析は形態素単位で行われ、文脈は考慮できない

2. LLMによるパラメーターの調整（補助）
- OpenAIのAPI（gpt-4o-mini）を使用して分析する。ChatGPTに「この文字にはどんなパラメーターが最適だと思う？」と聞いているイメージ。その結果を加味してk-NNで導出したパラメーターを調整する
- 判断材料として、人間が書いた指示と、k-NN学習データの傾向を自然言語で記述させたものを与えている
- 形態素単位では導き出せない文脈やニュアンスをある程度捕捉できる
- 学習サンプル不足のせいでk-NNの確信度が低い場合、LLMが修正できる


主な工夫点
----------

■ ハイブリッド推論のk-NN優先設計
  LLMが「自然=柔らかい」のような短絡的一般化でk-NNの結果を
  上書きしないよう、複数の制約を設けている:

  - パラメータ一貫性スコア:
    類似サンプル間の各パラメータの分散を計算し、
    分散が小さい（＝ユーザーの意図が明確な）パラメータは
    LLMによる変更を禁止する

  - 物性ベースの分析指示:
    モチーフをカテゴリ（自然/戦闘…）で捉えるのではなく、
    対象物の物理的質感（枝→細い・硬い、滝→太い・力強い）で
    判断するようLLMに指示

  - 類似度連動の介入度制御:
    k-NNの最高類似度に応じてLLMの調整幅を段階的に制限

■ k-NNベースの蒸留（Prompt Distillation）
  全サンプルのembedding類似度行列からクラスタリング・
  ニュアンス境界ペア検出・LOO外れ値検出を行い、
  その構造情報をLLMに渡して自然言語ルールを抽出する。
  抽出されたルールは以降の推論プロンプトに組み込まれる。

  - クラスタ分析: 類似度≥0.65の連結成分でグルーピング
  - ニュアンス境界: 意味的に近い(≥0.7)がパラメータが異なるペア
  - 外れ値検出: LOO交差検証でk-NNが予測を外すケースを特定

■ 動的フォントサイズ
  テキストの文字数とキャンバスサイズに応じてフォントサイズを
  自動調整。設定値を下限とし、短いテキストは大きく表示する。

■ サンプルテキスト生成
  LLMで多様なカテゴリ（ニュース・詩・官能・ホラー・サブカル等
  100種以上）からテキストを生成し、学習データの偏りを防ぐ。

■ localStorage耐障害設計
  容量超過時にキャッシュを段階的に削除し、
  最悪の場合はembeddingなしで保存するフォールバック処理。


先行研究との関係
----------------
テキスト内容からフォントを選択する研究（"Let Me Choose", ACL 2020）や
フォント印象の埋め込み（Impression-CLIP, 2024）が存在するが、
本システムには以下の独自性がある:

- 離散的フォント選択ではなく、連続パラメータ空間での予測
- ユーザー個人の美的嗜好の逐次学習（k-NN + LLMハイブリッド）
- 蒸留によるルール抽出とプロンプトへの再帰的組み込み
- ストローク単位のパラメトリック制御


ファイル構成
------------
index.html              UI・フロントエンドロジック
style.css               スタイル
impression_model.js     推論エンジン（k-NN/LLM/ハイブリッド/蒸留）
sketches/sketch1/       p5.jsスケッチ（描画ロジック）
data/                   フォントデータ（M+ ストロークJSON）
fonts/                  フォントファイル
